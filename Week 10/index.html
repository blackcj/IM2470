<!doctype html>
<html>
<head>
<meta charset="UTF-8">
<title>Raphael Demo</title>

<script type="text/javascript" src="raphael-min.js"></script>
<script type="text/javascript" src="raphael.free_transform.js"></script>
<script src="http://cdnjs.cloudflare.com/ajax/libs/gsap/1.9.7/TweenMax.min.js"></script>

</head>

<body>


<button onClick="playback();" style="position:absolute;top:500px;">Playback</button>
<div id="holder" style="height: 100%; background-color:#CCC"></div>


<script type="text/javascript">
    var paper = Raphael(0, 0, 500, 500);
	var history = Array();
    var rect = paper
        .rect(200, 200, 100, 100)
        .attr('fill', '#f00')
        ;

    // Add freeTransform
    var ft = paper.freeTransform(rect);

    // Show hidden freeTransform handles
    ft.showHandles();

    // Apply transformations programmatically
    //ft.attrs.rotate = 45;
	
    ft.apply();

    // Remove freeTransform completely
    ft.unplug();

    // Add freeTransform with options and callback
	function addTransform() {
		ft = paper.freeTransform(rect, { keepRatio: true, size: 30 }, function(ft, events) {
			var evtString = events.join(', ');
			if(evtString.indexOf("end") >= 0){
				console.log(evtString);//ft.attrs);
				// push ft.attrs into an array deep copy to retain data
				history.push(clone(ft.attrs));
			}else if(evtString.indexOf("start") >= 0 && history.length == 0){
				history.push(clone(ft.attrs));
			}
		});
		// Push starting position
		//history.push(clone(ft.attrs));
	}
	addTransform();
	
	// Star playback of animation
	function playback()
	{
		ft.unplug();
		// Take from the top of the array
		if(history.length > 0){
			var toAttrs = history.pop();
			console.log(toAttrs);
			TweenMax.killAll();
			if(ft.attrs.translate.x == toAttrs.translate.x && ft.attrs.translate.y == toAttrs.translate.y){
				TweenMax.to(ft.attrs.scale, 1, {x:toAttrs.scale.x, y:toAttrs.scale.y, onUpdate:updateRect, onComplete:playback});
				TweenMax.to(ft.attrs, 1, {rotate:toAttrs.rotate, onUpdate:updateRect});
			} else {
				TweenMax.to(ft.attrs.translate, 1, {x:toAttrs.translate.x, y:toAttrs.translate.y, onUpdate:updateRect, onComplete:playback});
			}
			
		}else {
			addTransform();	
		}
	}
	
	// deep copy to retain data
	function clone(obj) {
		// Handle the 3 simple types, and null or undefined
		if (null == obj || "object" != typeof obj) return obj;
	
		// Handle Date
		if (obj instanceof Date) {
			var copy = new Date();
			copy.setTime(obj.getTime());
			return copy;
		}
	
		// Handle Array
		if (obj instanceof Array) {
			var copy = [];
			for (var i = 0, len = obj.length; i < len; i++) {
				copy[i] = clone(obj[i]);
			}
			return copy;
		}
	
		// Handle Object
		if (obj instanceof Object) {
			var copy = {};
			for (var attr in obj) {
				if (obj.hasOwnProperty(attr)) copy[attr] = clone(obj[attr]);
			}
			return copy;
		}
	
		throw new Error("Unable to copy obj! Its type isn't supported.");
	}
	
	// Update transform on every GreenSock update
	function updateRect()
	{
		ft.apply();
	}


</script>
</body>
</html>
